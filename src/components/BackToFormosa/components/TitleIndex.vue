<template>
  <div class="the-index" @mouseleave="closeSideBar">
    <template v-if="isMounted && isMobW">
      <svg class="the-index__prompt" v-if="!isOpen" height="70" viewBox="0 0 35 70" width="35" xmlns="http://www.w3.org/2000/svg" @click="toggleSidebar">
        <g fill="none" fill-rule="evenodd">
          <path d="m35 0v70c-19.3299662 0-35-15.6700338-35-35s15.6700338-35 35-35z" fill="#000" fill-rule="nonzero" opacity=".7"/>
          <path :d="numPathMob" fill="#fff"/>
          <path d="m11 33h20v2h-20z" fill="#9b9b9b" fill-rule="nonzero"/>
          <path d="m26.752 47.266c0 .6413365-.1516651 1.2523304-.455 1.833s-.6976642 1.1223308-1.183 1.625-1.0226637.9619979-1.612 1.378-1.1656638.7669986-1.729 1.053c-.5633361.2860014-1.0789977.5069992-1.547.663s-.8233321.234-1.066.234c-.2600013 0-.5676649-.0736659-.923-.221s-.7193315-.3509987-1.092-.611-.7323316-.5633316-1.079-.91-.6326655-.7193313-.858-1.118c-.0866671-.1040005-.1429999-.2426658-.169-.416s-.039-.3553324-.039-.546c0-1.4560073.4116625-2.8686598 1.235-4.238.8233374-1.3693402 2.1883238-2.6433274 4.095-3.822.7800039-.4506689 1.3563315-.7583325 1.729-.923s.662999-.247.871-.247c.5200026 0 1.6553246.4939951 3.406 1.482-1.1440057.1040005-2.2143284.3163317-3.211.637s-1.8719962.7279975-2.626 1.222-1.369331 1.0616635-1.846 1.703c-.4766691.6413365-.7669995 1.3346629-.871 2.08.3986687-.4160021.8363309-.8059982 1.313-1.17.476669-.3640018.9749974-.680332 1.495-.949s1.0443307-.4809992 1.573-.637 1.0356642-.234 1.521-.234c.329335 0 .6759982.0649993 1.04.195s.6976651.298999 1.001.507.5503324.4376654.741.689.286.4983321.286.741zm-3.848-.676c-.5546694.0693337-1.1223304.2339987-1.703.494s-1.1093309.5633316-1.586.91c-.476669.3466684-.8709984.7236646-1.183 1.131s-.468.7929982-.468 1.157c0 .3120016.0433329.6109986.13.897s.2773319.697664.572 1.235c.0520003.1040005.1646658.1819997.338.234s.4853311.0953332.936.13c1.4213404-.8320042 2.4223304-1.7073287 3.003-2.626s.871-1.8979948.871-2.938z" fill="#9b9b9b"/>
        </g>
      </svg>
      <svg class="the-index__prompt" v-else @click="toggleSidebar" height="70" viewBox="0 0 35 70" width="35" xmlns="http://www.w3.org/2000/svg"><g fill="none"><path d="m35 0v70c-19.3299662 0-35-15.6700338-35-35s15.6700338-35 35-35z" fill="#a66c69"/><path d="m22 27 10 16h-20z" fill="#fff" transform="matrix(0 1 -1 0 57 13)"/></g></svg>

      <div class="the-index__side" :class="{ open: isOpen }">
        <ul>
          <li v-for="(title, idx) in titles" @click="scrollToTitle(title.id)" :key="title.id" :class="{ active: isCurtIndex(idx) }">{{ idx + 1 }} {{ title.name }}</li>
        </ul>
      </div>
    </template>
    <template v-else>
      <ul class="the-index__float">
        <li v-for="(title, idx) in titles" :key="title.id" :class="{ active: isActive(idx), another: needAnotherStyle }">
          <transition name="fadeIn">
            <div class="the-index__name" v-if="isActives[ idx ]">{{ title.name }}</div>
          </transition>
          <div class="the-index__num" @click="scrollToTitle(title.id)" @mouseenter="activeIndex(idx)" @mouseleave="inactiveIndex(idx)">
            <img :src="`/proj-assets/backtoformosa/img/index/${idx + 1}-${isActive(idx) ? ( needAnotherStyle ? 'red' : 'white') : 'gray'}${needAnotherStyle ? '' : '-shadow'}.svg`" alt="">
          </div>
        </li>
      </ul>
    </template>
  </div>
</template>

<script>
import { ScrollController, isEl } from '../util/index.js'

const scrollIntoView = require('scroll-into-view')

export default {
  name: 'TitleIndex',
  data () {
    return {
      isOpen: false,
      curtIndex: 1,
      titles: [
        {
          id: 'opening',
          name: '楔子',
          num: ''
        },
        {
          id: 'scene1',
          name: '第一幕：逮捕'
        },
        {
          id: 'scene2',
          name: '第二幕：偵訊'
        },
        {
          id: 'scene3',
          name: '第三幕：大審'
        },
        {
          id: 'ending',
          name: '最後陳述'
        },
        {
          id: 'after',
          name: '大審之後'
        }
      ],
      paths: {
        mob: [
          'm24.396 15.248c0 .7106702-.1169988 1.5729949-.351 2.587s-.5416648 2.0756611-.923 3.185-.8103309 2.2056613-1.287 3.289c-.4766691 1.0833388-.9576642 2.058329-1.443 2.925l-2.054-.962c.4506689-.8320042.8579982-1.7073287 1.222-2.626s.6716654-1.8069957.923-2.665.4463326-1.6336632.585-2.327.208-1.2219982.208-1.586v-1.04h-.416c-.3986687.1213339-.7756649.2339995-1.131.338s-.8103306.2426658-1.365.416l-.364-1.222c.5893363-.1560008 1.1353308-.2989993 1.638-.429.5026692-.1300006.9836644-.2556661 1.443-.377s.9143311-.2426661 1.365-.364.9099977-.2513326 1.378-.39l.572.494z',
          'm27.584 18.1733824c0 .4680023-.2556641.9663307-.767 1.495s-1.2219955 1.0703305-2.132 1.625c-.9100045.5546694-2.0063269 1.1223304-3.289 1.703-1.2826731.5806695-2.686659 1.1656637-4.212 1.755.9360047-.121334 1.7766629-.2079998 2.522-.26.7453371-.0520003 1.44733-.078 2.106-.078s1.2999969.0216664 1.924.065c.6240031.0433335 1.2913298.1083329 2.002.195l-.962 2.21c-.7973373-.1386674-1.5209968-.2426664-2.171-.312-.6500033-.0693337-1.2956635-.104-1.937-.104s-1.3173298.0346663-2.028.104c-.7106702.0693336-1.5339953.1733326-2.47.312l-1.17-2.418c1.0400052-.2946682 2.097328-.710664 3.172-1.248 1.074672-.5373361 2.0669954-1.1396634 2.977-1.807.9100045-.6673367 1.6986633-1.373663 2.366-2.119.6673367-.7453371 1.1223321-1.4819964 1.365-2.21l-.936-1.014h-.884c-.537336 0-1.2003294.1083322-1.989.325-.7886706.2166677-1.8069938.6023305-3.055 1.157l-1.118-1.82c1.3520068-.5893363 2.4959953-1.0269986 3.432-1.313.9360047-.2860015 1.7593298-.4246667 2.47-.416s1.3433306.1646651 1.898.468c.5546694.3033348 1.1353303.7409971 1.742 1.313.2946681.2946681.5589988.667331.793 1.118.2340012.4506689.351.8753313.351 1.274z',
          'm27.208 16.912c0 .1906676-.0909991.3856657-.273.585s-.4939978.4203321-.936.663-1.0356629.5199984-1.781.832-1.6899943.6673313-2.834 1.066c.3986687-.0520003.7453319-.0866666 1.04-.104s.6413313-.026 1.04-.026c.3640018 0 .7279982.0866658 1.092.26s.6933319.3856654.988.637.5329991.5286651.715.832c.1820009.3033348.273.5849987.273.845 0 .6933368-.6239938 1.4386627-1.872 2.236-.7106702.4506689-1.3823302.8233319-2.015 1.118s-1.2609969.5329991-1.885.715-1.2523302.3119996-1.885.39-1.2956632.117-1.989.117c-.9360047 0-1.6509975-.1256654-2.145-.377s-.741-.6023311-.741-1.053c0-.2253345.1256654-.3813329.377-.468s.6543306-.0520008 1.209.104c.7453371.208001 1.3649975.3509996 1.859.429s1.0356637.117 1.625.117c.208001 0 .4809983-.0693326.819-.208s.6976648-.3249988 1.079-.559.7583315-.5069984 1.131-.819.6889987-.6499982.949-1.014c.2253345-.2946681.2990004-.5503323.221-.767-.0780004-.2166678-.3769974-.5243313-.897-.923-.1906676-.1386674-.4029988-.2556662-.637-.351s-.515665-.1603332-.845-.195-.7149978-.0390001-1.157-.013-.9576637.0909995-1.547.195l-.468-.858c.9360047-.3120016 1.8026627-.6543315 2.6-1.027s1.494997-.7453315 2.093-1.118 1.0833315-.723665 1.456-1.053.6109995-.597999.715-.806l-.572-.52c-1.0573386.0346668-2.0756618.1473324-3.055.338s-2.066994.4679982-3.263.832l-1.066-1.586c1.525341-.5200026 2.7993282-.8796657 3.822-1.079s1.9413293-.299 2.756-.299c.6066697 0 1.1526642.0909991 1.638.273s.9533311.4809979 1.404.897c.2600013.2253345.4853324.502665.676.832s.286.6326653.286.91z',
          'm25.9497144 24.868c-.208001-.0173334-.4506653-.0303333-.728-.039s-.5286655-.013-.754-.013c-.2600013.4160021-.524332.818998-.793 1.209-.268668.3900019-.5329987.7669982-.793 1.131l-1.586.234c.2600013-.4333355.493999-.8753311.702-1.326s.3986658-.9013311.572-1.352c-.6760034.0173334-1.2869973.0389999-1.833.065s-1.0746641.0563332-1.586.091-1.035664.0779997-1.573.13-1.13533.1126663-1.794.182c-.2253345-.2946681-.3986661-.5329991-.52-.715s-.1993332-.3379994-.234-.468c-.0346668-.1300007-.0390001-.2426662-.013-.338s.0736663-.2123326.143-.351c.4506689-.8493376.9143309-1.676996 1.391-2.483.476669-.806004.9446644-1.5599965 1.404-2.262s.8926646-1.3259973 1.3-1.872.7669984-.983665 1.079-1.313c.2773347-.2773347.5243322-.4723328.741-.585.2166677-.1126672.5503311-.2036663 1.001-.273.3466684-.0520003.6499987-.0996665.91-.143.2600013-.0433336.5069988-.0823332.741-.117s.4766654-.0736665.728-.117c.2513346-.0433336.5503316-.0909997.897-.143-.5720029.5026692-1.1656636 1.0789967-1.781 1.729-.6153364.6500032-1.2306636 1.3389964-1.846 2.067s-1.2089971 1.4776628-1.781 2.249-1.1006642 1.5209964-1.586 2.249l-1.976 1.43c.8840044-.1386674 1.8503281-.2599995 2.899-.364s2.335659-.1993329 3.861-.286c.1213339-.4680023.2209996-.9056646.299-1.313s.1386664-.8059981.182-1.196c.0433335-.390002.065-.7756648.065-1.157s-.0173332-.7886645-.052-1.222l2.808 1.17c-.0346668.7280036-.1213326 1.3693306-.26 1.924s-.3813316 1.16133-.728 1.82c.3120016.0173334.602332.026.871.026s.4983324.0173332.689.052z',
          'm27.208 16.4765001c-.6066697-.1386674-1.1656641-.2513329-1.677-.338s-1.0096642-.1516665-1.495-.195c-.4853358-.0433336-.9706642-.0693333-1.456-.078s-.996664-.0043334-1.534.013c-.5026692.6413365-.9403315 1.2436638-1.313 1.807-.3726685.5633361-.7756645 1.2089963-1.209 1.937.5546694-.1386674 1.1743299-.2426663 1.859-.312s1.4776622-.104 2.379-.104c.7106702 0 1.2653313.0433329 1.664.13s.7453319.2686653 1.04.546c.4333355.3640018.7106661.6413324.832.832s.182.4419984.182.754c0 .7973373-.3163302 1.5383299-.949 2.223s-1.4386618 1.2826641-2.418 1.794-2.0539941.9099985-3.224 1.196c-1.1700058.2860014-2.292328.429-3.367.429-.5720029 0-.9879987-.0303331-1.248-.091-.2600013-.060667-.4506661-.1343329-.572-.221-.208001-.1386674-.3769993-.3076657-.507-.507-.1300006-.1993344-.195-.402999-.195-.611 0-.1386674.0173332-.2513329.052-.338s.1039995-.1473332.208-.182c.1040005-.0346669.2513324-.0433334.442-.026s.450665.0606663.78.13c.5026692.1040005.9359982.1993329 1.3.286s.6673321.1646663.91.234c.6413365.1733342 1.1439982.1733342 1.508 0 .5893363-.2773347 1.1309975-.5849983 1.625-.923s.9143316-.6846649 1.261-1.04.6153324-.7063316.806-1.053.286-.6673319.286-.962c0-.3466684-.1083322-.6023325-.325-.767-.2166677-.1646675-.6456635-.247-1.287-.247-.6066697 0-1.1223312.0086666-1.547.026s-.801665.0476664-1.131.091c-.329335.0433335-.628332.1039996-.897.182s-.5416653.177666-.819.299l-1.066-.884c.7453371-1.0920055 1.3953306-2.1276618 1.95-3.107.5546694-.9793383 1.0313313-1.9976614 1.43-3.055.7453371-.1386674 1.4603299-.2339998 2.145-.286.6846701-.0520003 1.3779965-.0693334 2.08-.052s1.4429961.0779995 2.223.182 1.6379953.2426658 2.574.416z',
          'm27.752 20.266c0 .6413365-.1516651 1.2523304-.455 1.833s-.6976642 1.1223308-1.183 1.625-1.0226637.9619979-1.612 1.378-1.1656638.7669986-1.729 1.053c-.5633361.2860014-1.0789977.5069992-1.547.663s-.8233321.234-1.066.234c-.2600013 0-.5676649-.0736659-.923-.221s-.7193315-.3509987-1.092-.611-.7323316-.5633316-1.079-.91-.6326655-.7193313-.858-1.118c-.0866671-.1040005-.1429999-.2426658-.169-.416s-.039-.3553324-.039-.546c0-1.4560073.4116625-2.8686598 1.235-4.238.8233374-1.3693402 2.1883238-2.6433274 4.095-3.822.7800039-.4506689 1.3563315-.7583325 1.729-.923s.662999-.247.871-.247c.5200026 0 1.6553246.4939951 3.406 1.482-1.1440057.1040005-2.2143284.3163317-3.211.637s-1.8719962.7279975-2.626 1.222-1.369331 1.0616635-1.846 1.703c-.4766691.6413365-.7669995 1.3346629-.871 2.08.3986687-.4160021.8363309-.8059982 1.313-1.17.476669-.3640018.9749974-.680332 1.495-.949s1.0443307-.4809992 1.573-.637 1.0356642-.234 1.521-.234c.329335 0 .6759982.0649993 1.04.195s.6976651.298999 1.001.507.5503324.4376654.741.689.286.4983321.286.741zm-3.848-.676c-.5546694.0693337-1.1223304.2339987-1.703.494s-1.1093309.5633316-1.586.91c-.476669.3466684-.8709984.7236646-1.183 1.131s-.468.7929982-.468 1.157c0 .3120016.0433329.6109986.13.897s.2773319.697664.572 1.235c.0520003.1040005.1646658.1819997.338.234s.4853311.0953332.936.13c1.4213404-.8320042 2.4223304-1.7073287 3.003-2.626s.871-1.8979948.871-2.938z'
        ]
      },
      scrollController: null,
      canClick: true,
      isMounted: false,
      isActives: [ false, false, false, false, false, false ],
      needAnotherStyle: false
    }
  },
  computed: {
    numPathMob () {
      return this.paths.mob[ this.curtIndex - 1 ]
    },
    ww () {
      return this.$store.state.viewport[ 0 ]
    },
    isMobW () {
      return this.ww <= 767.98
    }
  },
  mounted () {
    this.isMounted = true

    this.scrollController = new ScrollController()
    this.titles.forEach((title, idx) => {
      this.changeIndex(idx + 1, this.titleEl(title.id))
    })

    new ScrollController().lineScene({
      order: 1,
      triggerEl: this.$parent.$refs.scene1,
      whOffset: 0.5,
      enterFn: () => { this.needAnotherStyle = true },
      leaveFn: () => { this.needAnotherStyle = false }
    })
  },
  methods: {
    toggleSidebar () {
      this.isOpen = !this.isOpen
    },
    closeSideBar () {
      this.isOpen = false
    },
    scrollToTitle (id) {
      if (!this.canClick) { return }

      this.canClick = false
      scrollIntoView(
        this.titleEl(id),
        { time: 750, align: { top: 0, left: 0 }, ease: (t) => t * t * t },
        () => { this.canClick = true }
      )
    },
    changeIndex (index = 1, triggerEl) {
      this.scrollController.lineScene({
        order: index,
        triggerEl,
        whOffset: 0.01,
        enterFn: () => { this.curtIndex = index },
        leaveFn: () => { this.curtIndex = index - 1 > 0 ? index - 1 : 1 }
      })
    },
    titleEl (id) {
      const el = this.$parent.$refs[ id ]
      return isEl(el) ? el : el.$el
    },
    activeIndex (idx) {
      this.$set(this.isActives, idx, true)
    },
    inactiveIndex (idx) {
      this.$set(this.isActives, idx, false)
    },
    isCurtIndex (idx) {
      return this.curtIndex === idx + 1
    },
    isActive (idx) {
      return this.isActives[ idx ] || this.isCurtIndex(idx)
    }
  }
}
 </script>

<style lang="stylus">
@import '../util/global.styl'

.the-index
  user-select none
  @media (min-width $breakpoint-md)
    position fixed
    z-index 29
    top 50%
    right 42px
    transform translateY(-50%)
    color #fff
    font-size 1.4rem
    line-height 1.4
  &__prompt
    position fixed
    right 0
    bottom 20px
    z-index 29
    cursor pointer
  &__float
    & li
      display flex
      align-items center
      justify-content flex-end
      & + li
        margin-top 35px
      &.active .the-index
        &__num::after
          width 25px
      &.another .the-index
        &__name
          color #a56c6a
        &__num::after
          background-color #a56c6a
  &__num
    position relative
    margin-left 12.5px
    cursor pointer
    &::after
      content: ''
      display block
      position absolute
      left 50%
      transform translateX(-50%)
      top 18px
      width 0px
      height 2px
      background-color #fff
      transition width 0.3s $easeInOutSine
  &__side
    position fixed
    top 0
    right 0
    width 180px
    background-color #000
    height 100%
    z-index 19
    color #fff
    font-size 1.6rem
    line-height 1.4
    display flex
    justify-content center
    align-items center
    transform translateX(100%)
    transition transform 0.15s $easeInOutSine
    &.open
      transform translateX(0%)
      box-shadow 0 2px 4px 0 rgba(0, 0, 0, 0.5)
    & li
      cursor pointer
      transition all 0.15s $easeInOutSine
      &.active, &:hover
        font-weight 500
        color #a66c69
      & + li
        margin-top 22.4px
.fadeIn
  &-enter-active, &-leave-active
    transition opacity 0.3s $easeInOutSine
  &-enter, &-leave-to
    opacity 0
</style>
